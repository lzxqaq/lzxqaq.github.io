<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>C&#43;&#43; 动态库的二进制兼容性问题 | Zexun Luo | 罗泽勋</title>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">    
<meta name="viewport" content="width=device-width,minimum-scale=1">
<meta name="description" content="一、定义 🔗 二进制兼容：在升级库文件的时候，不必重新编译使用此库的可执行文件或其他库文件，并且程序的功能不被破坏。
源码兼容：在升级库文件的时候，不必修改使用此库的可执行文件或其他库文件的源代码，只需重新编译应用程序，即可使程序的功能不被破坏。
二进制兼容性可以解决很多麻烦，它会使为特定平台分发软件时变得更容易。 如果不能确保发行版之间的二进制兼容性，人们将不得不提供静态链接的二进制文件。 静态二进制文件很糟糕，因为它们
浪费资源（尤其是内存） 程序不能从库的bug修复或功能扩展中受益 二、ABI 和 API 🔗 应用二进制接口（application binary interface，缩写为 ABI）描述了应用程序（或者其他类型）和操作系统之间或其他应用程序的低级接口。ABI涵盖了各种细节，如：数据类型的大小、布局和对齐；调用约定等。
在了解二进制兼容和源码兼容两个定义以后，我们再看与其类似且对应的两个概念：ABI和API。ABI不同于API（应用程序接口），API定义了源代码和库之间的接口，因此同样的代码可以在支持这个API的任何系统中编译，然而ABI允许编译好的目标代码在使用兼容ABI的系统中无需改动就能运行。
举个例子，在Qt和Java两种跨平台程序中，API像是Qt的接口，Qt有着通用接口，源代码只需要在支持Qt的环境下编译即可。ABI更像是Jvm，只要支持Jvm的系统上，都可以运行已有的Java程序。
三、C&#43;&#43; 的 ABI 🔗ABI更像是一个产品的使用说明书，同理C&#43;&#43;的ABI就是如何使用C&#43;&#43;生成可执行程序的一张说明书。编译器会根据这个说明书，生成二进制代码。C&#43;&#43;的ABI在不同的编译器下会略有不同。
C&#43;&#43;ABI的部分内容举例：
函数参数传递的方式，比如 x86-64 用寄存器来传函数的前 4 个整数参数 虚函数的调用方式，通常是 vptr/vtbl 然后用 vtbl[offset] 来调用 struct 和 class 的内存布局，通过偏移量来访问数据成员 综上所述，如果可执行程序通过以上说明书访问动态链接库A，以及此库的升级版本A&#43;，若按此说明书上的方法，可以无痛的使用A和A&#43;，那么我们就称库A的这次升级是二进制兼容的。
四、破坏二进制兼容的常见方式 🔗 添加新的虚函数 取消导出或删除已导出的类。 以任何方式更改类层次结构（添加，删除或重新排序基类）。 改变虚函数声明时的顺序（偏移量改变，导致调用失败） 添加新的非静态成员变量（类的内存布局改变，偏移量也发生变化） 改变非静态成员变量的声明顺序 以任何方式更改模板参数（添加，删除或重新排序）。 五、不会破坏二进制兼容的几种常见方式 🔗 添加非虚函数（包括构造函数） 添加新的类 添加Qt中的信号、槽 添加新的枚举或者在已存在的枚举类型中添加一个枚举值 添加新的静态成员变量 修改成员变量名称（偏移量未改变） 添加Q_OBJECT,Q_PROPERTY, Q_ENUMS ,Q_FLAGS宏，添加这些宏都是修改了moc生成的文件，而不是类本身 重新实现在类层次结构中原始基类定义的虚函数，如果程序链接到先前版本的库，且该库调用了基类中的实现而不是派生类中的实现，是安全的。这很棘手，可能很危险。三思而后行。 移除私有非虚函数，如果它们没有被任何内联函数调用过（并且从未使用过）。 移除私有静态成员变量，如果它们没有被任何内联函数调用过（并且从未使用过）。 更改方法的默认参数。但是，它需要重新编译才能使用实际的新的默认参数值。 导出以前未导出的类。 在类中添加或删除友元声明。 六、库程序员的技巧（解决二进制兼容问题） 🔗编写库时最大的问题是，不能安全地添加数据成员，因为这会改变每个class类，struct结构，或者对象类型数组的大小和布局。
1.位标志 🔗位标志是一种例外。 如果对枚举或布尔使用位标志，则至少在下一个字节减去1bit之前是安全的。具有下面成员的类">
<meta name="generator" content="Hugo 0.110.0">


  <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="stylesheet" href="/css/style.css">



<link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon" />
<link href="https://cdn.bootcss.com/aplayer/1.10.1/APlayer.min.css" rel="stylesheet">
<script src="https://cdn.bootcss.com/aplayer/1.10.1/APlayer.min.js"></script>

 
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-KDTTBGMLCQ', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







  </head>

  <body>
    <nav class="navigation">
	
		<a href="/"> <span class="arrow">←</span>首页</a>
	
	<a href="/posts">归档</a>
	<a href="/tags">标签</a>
	<a href="/about">关于</a>

	

	
</nav>


    <main class="main">
      



<section id="single">
    <h1 class="title">C&#43;&#43; 动态库的二进制兼容性问题</h1>

    <div class="tip">
        <time datetime="2022-04-13 12:26:14 &#43;0800 CST">2022年04月13日</time>
        <span class="split">
          ·
        </span>
        <span>
          109字
        </span>
        <span class="split">
          ·
        </span>
        <span>
          1分钟
        </span>
    </div>

    
    
    


    <div class="content">
      <h3 id="一定义">一、定义 <a href="#%e4%b8%80%e5%ae%9a%e4%b9%89" class="anchor">🔗</a></h3><ul>
<li>
<p>二进制兼容：在升级库文件的时候，不必重新编译使用此库的可执行文件或其他库文件，并且程序的功能不被破坏。</p>
</li>
<li>
<p>源码兼容：在升级库文件的时候，不必修改使用此库的可执行文件或其他库文件的源代码，只需重新编译应用程序，即可使程序的功能不被破坏。</p>
</li>
</ul>
<p>二进制兼容性可以解决很多麻烦，它会使为特定平台分发软件时变得更容易。 如果不能确保发行版之间的二进制兼容性，人们将不得不提供静态链接的二进制文件。 静态二进制文件很糟糕，因为它们</p>
<ul>
<li>浪费资源（尤其是内存）</li>
<li>程序不能从库的bug修复或功能扩展中受益</li>
</ul>
<h3 id="二abi-和-api">二、ABI 和 API <a href="#%e4%ba%8cabi-%e5%92%8c-api" class="anchor">🔗</a></h3><blockquote>
<p>应用二进制接口（application binary interface，缩写为 ABI）描述了应用程序（或者其他类型）和操作系统之间或其他应用程序的低级接口。ABI涵盖了各种细节，如：数据类型的大小、布局和对齐；调用约定等。</p>
</blockquote>
<p>在了解二进制兼容和源码兼容两个定义以后，我们再看与其类似且对应的两个概念：ABI和API。ABI不同于API（应用程序接口），API定义了源代码和库之间的接口，因此同样的代码可以在支持这个API的任何系统中编译，然而ABI允许编译好的目标代码在使用兼容ABI的系统中无需改动就能运行。</p>
<p>举个例子，在Qt和Java两种跨平台程序中，API像是Qt的接口，Qt有着通用接口，源代码只需要在支持Qt的环境下编译即可。ABI更像是Jvm，只要支持Jvm的系统上，都可以运行已有的Java程序。</p>
<h3 id="三c-的-abi">三、C++ 的 ABI <a href="#%e4%b8%89c-%e7%9a%84-abi" class="anchor">🔗</a></h3><p>ABI更像是一个产品的使用说明书，同理C++的ABI就是如何使用C++生成可执行程序的一张说明书。编译器会根据这个说明书，生成二进制代码。C++的ABI在不同的编译器下会略有不同。</p>
<p>C++ABI的部分内容举例：</p>
<ul>
<li>函数参数传递的方式，比如 x86-64 用寄存器来传函数的前 4 个整数参数</li>
<li>虚函数的调用方式，通常是 vptr/vtbl 然后用 vtbl[offset] 来调用</li>
<li>struct 和 class 的内存布局，通过偏移量来访问数据成员</li>
</ul>
<p>综上所述，如果可执行程序通过以上说明书访问动态链接库A，以及此库的升级版本A+，若按此说明书上的方法，可以无痛的使用A和A+，那么我们就称库A的这次升级是二进制兼容的。</p>
<h3 id="四破坏二进制兼容的常见方式">四、破坏二进制兼容的常见方式 <a href="#%e5%9b%9b%e7%a0%b4%e5%9d%8f%e4%ba%8c%e8%bf%9b%e5%88%b6%e5%85%bc%e5%ae%b9%e7%9a%84%e5%b8%b8%e8%a7%81%e6%96%b9%e5%bc%8f" class="anchor">🔗</a></h3><ul>
<li>添加新的虚函数</li>
<li>取消导出或删除已导出的类。</li>
<li>以任何方式更改类层次结构（添加，删除或重新排序基类）。</li>
<li>改变虚函数声明时的顺序（偏移量改变，导致调用失败）</li>
<li>添加新的非静态成员变量（类的内存布局改变，偏移量也发生变化）</li>
<li>改变非静态成员变量的声明顺序</li>
<li>以任何方式更改模板参数（添加，删除或重新排序）。</li>
</ul>
<h3 id="五不会破坏二进制兼容的几种常见方式">五、不会破坏二进制兼容的几种常见方式 <a href="#%e4%ba%94%e4%b8%8d%e4%bc%9a%e7%a0%b4%e5%9d%8f%e4%ba%8c%e8%bf%9b%e5%88%b6%e5%85%bc%e5%ae%b9%e7%9a%84%e5%87%a0%e7%a7%8d%e5%b8%b8%e8%a7%81%e6%96%b9%e5%bc%8f" class="anchor">🔗</a></h3><ul>
<li>添加非虚函数（包括构造函数）</li>
<li>添加新的类</li>
<li>添加Qt中的信号、槽</li>
<li>添加新的枚举或者在已存在的枚举类型中添加一个枚举值</li>
<li>添加新的静态成员变量</li>
<li>修改成员变量名称（偏移量未改变）</li>
<li>添加Q_OBJECT,Q_PROPERTY, Q_ENUMS ,Q_FLAGS宏，添加这些宏都是修改了moc生成的文件，而不是类本身</li>
<li>重新实现在类层次结构中原始基类定义的虚函数，如果程序链接到先前版本的库，且该库调用了基类中的实现而不是派生类中的实现，是安全的。这很棘手，可能很危险。三思而后行。</li>
<li>移除私有非虚函数，如果它们没有被任何内联函数调用过（并且从未使用过）。</li>
<li>移除私有静态成员变量，如果它们没有被任何内联函数调用过（并且从未使用过）。</li>
<li>更改方法的默认参数。但是，它需要重新编译才能使用实际的新的默认参数值。</li>
<li>导出以前未导出的类。</li>
<li>在类中添加或删除友元声明。</li>
</ul>
<h3 id="六库程序员的技巧解决二进制兼容问题">六、库程序员的技巧（解决二进制兼容问题） <a href="#%e5%85%ad%e5%ba%93%e7%a8%8b%e5%ba%8f%e5%91%98%e7%9a%84%e6%8a%80%e5%b7%a7%e8%a7%a3%e5%86%b3%e4%ba%8c%e8%bf%9b%e5%88%b6%e5%85%bc%e5%ae%b9%e9%97%ae%e9%a2%98" class="anchor">🔗</a></h3><p>编写库时最大的问题是，不能安全地添加数据成员，因为这会改变每个class类，struct结构，或者对象类型数组的大小和布局。</p>
<h4 id="1位标志">1.位标志 <a href="#1%e4%bd%8d%e6%a0%87%e5%bf%97" class="anchor">🔗</a></h4><p>位标志是一种例外。 如果对枚举或布尔使用位标志，则至少在下一个字节减去1bit之前是安全的。具有下面成员的类</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>uint m1 : 1;
</span></span><span style="display:flex;"><span>uint m2 : 3;
</span></span><span style="display:flex;"><span>uint m3 : 1;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>uint m1 : 1;
</span></span><span style="display:flex;"><span>uint m2 : 3;
</span></span><span style="display:flex;"><span>uint m3 : 1;
</span></span><span style="display:flex;"><span>uint m4 : 2; // new member
</span></span></code></pre></div><p>不会破坏二进制兼容性。 请四舍五入到最多7位（如果已经大于8，则为15位）。使用最后一位可能会在某些编译器上引起问题。</p>
<h4 id="2使用-d-指针-pimpl-机制">2.使用 d 指针( PImpl 机制) <a href="#2%e4%bd%bf%e7%94%a8-d-%e6%8c%87%e9%92%88-pimpl-%e6%9c%ba%e5%88%b6" class="anchor">🔗</a></h4>
    </div>

    
        <div class="tags">
            
                <a href="/tags/c/c&#43;&#43;">C/C&#43;&#43;</a>
            
        </div>
    
    
    


<script src="https://utteranc.es/client.js"
repo=""
issue-term=""
theme=""
crossorigin="anonymous"
async>
</script>





</section>


    </main>
    
    <footer id="footer">
    

    <div class="copyright">
    
       © Copyright 
       2023 
       <span class="split">
        <svg fill="#bbbbbb" width="15" height="15" version="1.1" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15px" height="15px" viewBox="0 0 15 15">
  <path d="M13.91,6.75c-1.17,2.25-4.3,5.31-6.07,6.94c-0.1903,0.1718-0.4797,0.1718-0.67,0C5.39,12.06,2.26,9,1.09,6.75&#xA;&#x9;C-1.48,1.8,5-1.5,7.5,3.45C10-1.5,16.48,1.8,13.91,6.75z"/>
</svg>
       </span>
       罗泽勋
    
    </div>

    
</footer>



  </body>
</html>
